<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProcessorCluster Worker Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: #f5f5f5;
    }
    header {
      padding: 16px;
      background: #1f1f1f;
      border-bottom: 1px solid #333;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      flex: 1 1 auto;
    }
    label {
      font-size: 13px;
    }
    input[type="text"], input[type="number"] {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #181818;
      color: #f5f5f5;
    }
    button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      font-size: 13px;
    }
    button.secondary {
      background: #444;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    main {
      padding: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
      gap: 16px;
    }
    .panel {
      background: #181818;
      border-radius: 8px;
      padding: 12px 14px;
      border: 1px solid #2a2a2a;
    }
    .panel h2 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .panel small {
      color: #999;
    }
    pre {
      background: #111;
      border-radius: 4px;
      padding: 8px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 280px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    textarea {
      width: 100%;
      min-height: 200px;
      max-height: 400px;
      background: #111;
      border-radius: 4px;
      border: 1px solid #333;
      color: #f5f5f5;
      padding: 8px;
      font-family: "Fira Code", Consolas, monospace;
      font-size: 12px;
      resize: vertical;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row > * {
      flex: 0 0 auto;
    }
    .row .grow {
      flex: 1 1 auto;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #333;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 6px;
    }
    .status-ok {
      background: #22c55e;
    }
    .status-error {
      background: #ef4444;
    }
    .status-unknown {
      background: #6b7280;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ProcessorCluster Worker Dashboard</h1>
    <div>
      <label>
        Worker base URL:
        <input type="text" id="baseUrl" size="28" value="http://192.168.1.201:9000" />
      </label>
    </div>
    <div>
      <label>
        Refresh every (s):
        <input type="number" id="refreshInterval" value="5" min="0" style="width: 60px;" />
      </label>
      <button id="applyRefresh" class="secondary">Apply</button>
      <button id="refreshNow">Refresh now</button>
    </div>
  </header>

  <main>
    <!-- LEFT: Info & Health -->
    <section class="panel" id="infoPanel">
      <h2>Worker Info</h2>
      <div class="row">
        <div id="infoStatus">
          <span class="status-dot status-unknown"></span>
          <span>Unknown</span>
        </div>
      </div>
      <pre id="infoJson">No data yet.</pre>
    </section>

    <section class="panel" id="healthPanel">
      <h2>Worker Health</h2>
      <div class="row">
        <div id="healthStatus">
          <span class="status-dot status-unknown"></span>
          <span>Unknown</span>
        </div>
      </div>
      <pre id="healthJson">No data yet.</pre>
    </section>

    <!-- RIGHT: Job sender -->
    <section class="panel" style="grid-column: 1 / -1;">
      <h2>Submit Job</h2>

      <div class="row">
        <div class="grow">
          <label for="jobFile">Load job JSON from file:</label>
          <input type="file" id="jobFile" accept=".json,application/json" />
        </div>
        <button id="loadExample" class="secondary">Load example job</button>
      </div>

      <div class="row">
        <div class="grow">
          <small>Paste or edit job JSON here. It will be sent as-is to <code>POST /jobs</code>.</small>
        </div>
      </div>

      <textarea id="jobText" placeholder='{
  "protocol_version": 1,
  "job_id": "some-unique-id",
  "task": { ... },
  "runtime": { ... }
}'></textarea>

      <div class="row" style="margin-top: 8px;">
        <button id="sendJob">Send job</button>
        <button id="clearJob" class="secondary">Clear</button>
      </div>

      <div style="margin-top: 12px;">
        <small>Last job response:</small>
        <pre id="jobResponse">No job sent yet.</pre>
      </div>
    </section>
  </main>

  <script>
    const baseUrlInput = document.getElementById("baseUrl");
    const refreshIntervalInput = document.getElementById("refreshInterval");
    const applyRefreshBtn = document.getElementById("applyRefresh");
    const refreshNowBtn = document.getElementById("refreshNow");

    const infoStatusEl = document.getElementById("infoStatus");
    const infoJsonEl = document.getElementById("infoJson");

    const healthStatusEl = document.getElementById("healthStatus");
    const healthJsonEl = document.getElementById("healthJson");

    const jobFileInput = document.getElementById("jobFile");
    const jobTextArea = document.getElementById("jobText");
    const sendJobBtn = document.getElementById("sendJob");
    const clearJobBtn = document.getElementById("clearJob");
    const jobResponseEl = document.getElementById("jobResponse");
    const loadExampleBtn = document.getElementById("loadExample");

    let refreshTimer = null;

    function setStatusElement(el, status, text) {
      // status: "ok" | "error" | "unknown"
      const dot = el.querySelector(".status-dot");
      const label = el.querySelector("span:nth-child(2)");
      dot.className = "status-dot";
      if (status === "ok") {
        dot.classList.add("status-ok");
      } else if (status === "error") {
        dot.classList.add("status-error");
      } else {
        dot.classList.add("status-unknown");
      }
      label.textContent = text;
    }

    async function fetchJson(path) {
      const baseUrl = baseUrlInput.value.trim().replace(/\/+$/, "");
      const url = baseUrl + path;
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json"
        }
      });
      if (!res.ok) {
        throw new Error("HTTP " + res.status + " " + res.statusText);
      }
      return res.json();
    }

    async function refreshInfo() {
      try {
        const data = await fetchJson("/info");
        setStatusElement(infoStatusEl, "ok", `ID ${data.worker_id || "?"} @ ${data.hostname || "?"}`);
        infoJsonEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        setStatusElement(infoStatusEl, "error", "Error");
        infoJsonEl.textContent = "Error fetching /info:\n" + err;
      }
    }

    async function refreshHealth() {
      try {
        const data = await fetchJson("/health");
        const status = data.status === "ok" ? "ok" : "error";
        setStatusElement(healthStatusEl, status, `Status: ${data.status || "unknown"}`);
        healthJsonEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        setStatusElement(healthStatusEl, "error", "Error");
        healthJsonEl.textContent = "Error fetching /health:\n" + err;
      }
    }

    async function refreshAll() {
      await Promise.all([refreshInfo(), refreshHealth()]);
    }

    function startAutoRefresh() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
      const intervalSec = Number(refreshIntervalInput.value) || 0;
      if (intervalSec > 0) {
        refreshTimer = setInterval(refreshAll, intervalSec * 1000);
      }
    }

    applyRefreshBtn.addEventListener("click", () => {
      startAutoRefresh();
      refreshAll();
    });

    refreshNowBtn.addEventListener("click", () => {
      refreshAll();
    });

    // File upload -> load JSON into textarea
    jobFileInput.addEventListener("change", () => {
      const file = jobFileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        jobTextArea.value = reader.result;
      };
      reader.onerror = () => {
        alert("Failed to read file: " + reader.error);
      };
      reader.readAsText(file);
    });

    // Load example job
    loadExampleBtn.addEventListener("click", () => {
      const example = {
        protocol_version: 1,
        job_id: "example-" + Date.now(),
        task: {
          type: "debug_echo",
          payload: {
            message: "Hello from the dashboard!"
          }
        },
        runtime: {
          mode: "image",
          image: "alpine:latest",
          cmd: ["cat"],
          env: {
            EXAMPLE_ENV: "from-dashboard"
          },
          limits: {
            memory_mb: 256,
            max_runtime_seconds: 10
          }
        }
      };
      jobTextArea.value = JSON.stringify(example, null, 2);
    });

    // Clear job textarea
    clearJobBtn.addEventListener("click", () => {
      jobTextArea.value = "";
      jobResponseEl.textContent = "Cleared.";
    });

    // Send job
    async function sendJob() {
      const baseUrl = baseUrlInput.value.trim().replace(/\/+$/, "");
      const url = baseUrl + "/jobs";

      let parsed;
      try {
        parsed = JSON.parse(jobTextArea.value);
      } catch (err) {
        alert("Job JSON is invalid: " + err);
        return;
      }

      sendJobBtn.disabled = true;
      jobResponseEl.textContent = "Sending job...";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(parsed)
        });
        const text = await res.text();
        try {
          const json = JSON.parse(text);
          jobResponseEl.textContent = JSON.stringify(json, null, 2);
        } catch {
          jobResponseEl.textContent = text;
        }
      } catch (err) {
        jobResponseEl.textContent = "Error sending job:\n" + err;
      } finally {
        sendJobBtn.disabled = false;
      }
    }

    sendJobBtn.addEventListener("click", sendJob);

    // Initial
    startAutoRefresh();
    refreshAll();
  </script>
</body>
</html>
